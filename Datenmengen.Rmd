---
title: "Datenmengen"
author: "Daniel Zimmermann / David Lilek"
output:
  html_document:
    df_print: paged
    fig.align: center
    self_contained: yes
    fig.height: 4
    fig.width: 8
    theme: united
    toc: yes
    toc_depth: 4
    toc_float: yes
    number_sections: no
    code_folding: hide
---

# TO DO

* combine sample command with probability in the example below 57% 0 43% 1
* can be used for male/female
* `sex1[ahi_bl==0] <- sample(c(0,1), sum(ahi_bl==0), prob=c(0.57, 0.43), replace=TRUE)`

# Data Simulation

* variable hospitalization: in this case random assignment may not be the best way because symptomatic disease progression would lead to higher hospitalization rates than aysmptomatic disease progression
* time from positive testing to hospital admission is needed for cox model
  + found this [article](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7589278/)
  + it is a bit age-depended but overall it seems to be right skewed
  + [here](https://stackoverflow.com/questions/28099590/create-sample-vector-data-in-r-with-a-skewed-distribution-with-limited-range) i found how to create skewed data-sets
* sex
  + it seems as stated below in the comments than men are higher affected than women but don't know yet how to consider this in a useful way
* age
  + tried something but its random and doesnt take other variables into account

```{r}

library(tidyverse)
library(fitdistrplus)

#set.seed
set.seed(123)

# alpha

alpha.hosp <- data.frame(hosp=rep(TRUE, 764),
                         hosp_er=TRUE)

alpha.er <- data.frame(hosp=rep(FALSE, 1448-764),
                       hosp_er=TRUE)

alpha.rest <- data.frame(hosp=rep(FALSE, 34656-1448),
                         hosp_er=FALSE)


age.groups <- data.frame(left=c(rep(0, 2671), 
                                rep(10, 7373), 
                                rep(20, 6183), 
                                rep(30, 7364), 
                                rep(40, 5588), 
                                rep(50, 3196), 
                                rep(60, 1375), 
                                rep(70, 495), 
                                rep(80, 411)),
                         right=c(rep(10, 2671), 
                                 rep(20, 7373), 
                                 rep(30, 6183), 
                                 rep(40, 7364), 
                                 rep(50, 5588), 
                                 rep(60, 3196), 
                                 rep(70, 1375), 
                                 rep(80, 495), 
                                 rep(NA, 411)))


dist <- fitdistcens(age.groups, "gamma")
summary(dist)
a <- dist$estimate["shape"]
b <- dist$estimate["rate"]

curve(dgamma(x, a*1.2, b), from = 0, to = 100)

alpha.hosp$age <- round(rgamma(nrow(alpha.hosp), a*1.2, b))
alpha.er$age <- round(rgamma(nrow(alpha.er), a*1.1, b))
alpha.rest$age <- round(rgamma(nrow(alpha.rest), a*0.95, b))

alpha.hosp$week <- sample(c(13:20), nrow(alpha.hosp), replace=T, 
                          prob=c(23.9, 18.1, 14.5, 13.8, 11.7, 
                                 9.4, 5.5, 3.1))

alpha.er$week <- sample(c(13:20), nrow(alpha.er), replace=T, 
                          prob=c(23.9, 18.1, 14.5, 13.8, 11.7, 
                                 9.4, 5.5, 3.1))

alpha.rest$week <- sample(c(13:20), nrow(alpha.rest), replace=T, 
                          prob=c(21.5, 15.9, 13.3, 12.7, 11.9, 
                                 10.7, 7.7, 6.3))

alpha.hosp$vacc <- sample(c(TRUE, FALSE), 
                          nrow(alpha.hosp), 
                          replace=T, 
                          prob=c(228, 536))

alpha.er$vacc <- sample(c(TRUE, FALSE), 
                        nrow(alpha.er), 
                        replace=T, 
                        prob=c(353-228, 1095-536))

alpha.rest$vacc <- sample(c(TRUE, FALSE), 
                          nrow(alpha.rest), 
                          replace=T, 
                          prob=c(6627-353, 28029-1095))

alpha <- rbind(alpha.hosp, alpha.er, alpha.rest)

hosp_er_time <- c(round(rweibull(1448, 2, 6)), rep(14, 33208))
hosp_er_time[hosp_er_time>14] <- 14

alpha$time <- hosp_er_time

alpha$variant <- "alpha"

# delta

delta.hosp <- data.frame(hosp=rep(TRUE, 196),
                         hosp_er=TRUE)

delta.er <- data.frame(hosp=rep(FALSE, 498-196),
                       hosp_er=TRUE)

delta.rest <- data.frame(hosp=rep(FALSE, 8682-498),
                         hosp_er=FALSE)


age.groups <- data.frame(left=c(rep(0, 893), 
                                rep(10, 2089), 
                                rep(20, 1453), 
                                rep(30, 1793), 
                                rep(40, 1297), 
                                rep(50, 720), 
                                rep(60, 306), 
                                rep(70, 89), 
                                rep(80, 42)),
                         right=c(rep(10, 893), 
                                 rep(20, 2089), 
                                 rep(30, 1453), 
                                 rep(40, 1793), 
                                 rep(50, 1297), 
                                 rep(60, 720), 
                                 rep(70, 306), 
                                 rep(80, 89), 
                                 rep(NA, 42)))


dist <- fitdistcens(age.groups, "gamma")
summary(dist)
a <- dist$estimate["shape"]
b <- dist$estimate["rate"]

curve(dgamma(x, a, b), from = 0, to = 100)

delta.hosp$age <- round(rgamma(nrow(delta.hosp), a*1.2, b))
delta.er$age <- round(rgamma(nrow(delta.er), a*1.1, b))
delta.rest$age <- round(rgamma(nrow(delta.rest), a*0.95, b))

delta.hosp$week <- sample(c(13:20), nrow(delta.hosp), replace=T, 
                          prob=c(0.2, 1, 1.7, 4.2, 7.1, 
                                 15.7, 24.5, 45.5))

delta.er$week <- sample(c(13:20), nrow(delta.er), replace=T, 
                          prob=c(0.2, 1, 1.7, 4.2, 7.1, 
                                 15.7, 24.5, 45.5))

delta.rest$week <- sample(c(13:20), nrow(delta.rest), replace=T, 
                          prob=c(0.1, 0.8, 1.5, 4.0, 7.3, 
                                 16, 24.8, 46))

delta.hosp$vacc <- sample(c(TRUE, FALSE), 
                          nrow(delta.hosp), 
                          replace=T, 
                          prob=c(47, 149))

delta.er$vacc <- sample(c(TRUE, FALSE), 
                        nrow(delta.er), 
                        replace=T, 
                        prob=c(129-47, 369-149))

delta.rest$vacc <- sample(c(TRUE, FALSE), 
                          nrow(delta.rest), 
                          replace=T, 
                          prob=c(2001-129, 6681-369))

delta <- rbind(delta.hosp, delta.er, delta.rest)

hosp_er_time <- c(round(rweibull(498, 2, 6)), rep(14, 8682-498))
hosp_er_time[hosp_er_time>14] <- 14

delta$time <- hosp_er_time

delta$variant <- "delta"

data <- rbind(alpha, delta)
data$variant = as.factor(data$variant)


data <- data[sample(nrow(data)),]

str(data)
```


# Visualization 

```{r}
library(ggplot2)
#vaccination status
p <- ggplot(data=data, aes(fill=vacc, x=variant)) +
  geom_bar() +
  ggtitle("Vaccination status at date of specimen")
p
#time of hospitalisation
p <- ggplot() +
    geom_jitter(data=data[which(data$hosp_er),], aes(x=variant, y=time, color=variant)) 
p
# age
p<-ggplot(data, aes(x=age)) +
  geom_histogram() +
  theme(legend.position="right") +
  ggtitle("Age Distribution")
p
```


# Cox Regression

* [CoxRegression](http://www.sthda.com/english/wiki/cox-proportional-hazards-model)
* [CoxRegression](https://sphweb.bumc.bu.edu/otlt/mph-modules/bs/bs704_survival/BS704_Survival6.html)
* [CoxModelAssumptions](http://www.sthda.com/english/wiki/cox-model-assumptions)
* [Creating Survival Plots - Cheat Sheet](https://raw.githubusercontent.com/rstudio/cheatsheets/main/survminer.pdf)
* [CoxRegression nice plotting example](https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/)

## Cox Regression Table2

* MISSING: adjusted p value: regression adjustment for 
  + age (linear)
  + date (linear)
  + sex
  + index of multiple deprivation
  + and international traveller status.

### Frist try

* table2 I used 0,1,2 for hospitalization
* but it should be 2 models 0-1 and 0-2
* in this first try I tested 3 different time simulations: equal, skewed, skewed_v002 
* for this first try I also tested the assumptions

```{r message=FALSE, warning=FALSE}
#---------------------------------------------------------------
#Cox Regression

library("survival")
library("survminer")

res.cox <- coxph(Surv(time,hosp) ~ variant, data = data)
summary(res.cox)
ggsurvplot(survfit(res.cox), data = data, palette = "#2E9FDF",
           ggtheme = theme_minimal())

res.cox2 <- coxph(Surv(time,hosp_er) ~ variant, data = data)
summary(res.cox2)
ggsurvplot(survfit(res.cox2), data = data, palette = "#2E9FDF",
           ggtheme = theme_minimal())

```

```{r}
# visualize hazard ratio
ggforest(res.cox, data = data)
ggforest(res.cox2, data = data)
```


* Testing the [Assumptions](http://www.sthda.com/english/wiki/cox-model-assumptions)
  + p values should be higher than 0.05 (significance level)
```{r}
test.ph <- cox.zph(res.cox)
test.ph
ggcoxzph(test.ph)
ggcoxdiagnostics(res.cox, type = "dfbeta",
                 linear.predictions = FALSE, ggtheme = theme_bw())
ggcoxdiagnostics(res.cox, type = "deviance",
                 linear.predictions = FALSE, ggtheme = theme_bw())
```

### Second try

* here I built 2 models which is exactly what we want 
* first model uses hos==1 
  + in the paper they get a HR of 1·03 (0·88–1·21)
  + we got 0.9608 (0.8208-1.125)
* second model uses Hos==2
  + in the paper they get a HR of 1·39 (1·25–1·53)
  + we got 1.121 (1.009-1.246)

```{r message=FALSE, warning=FALSE}
#---------------------------------------------------------------
res.cox3 <- coxph(Surv(time, hosp) ~ variant + strata(week), data = data)
summary(res.cox3)

# trace(ggforest, edit = TRUE)

ggforest(res.cox3, data = data)


res.cox4 <- coxph(Surv(time,hosp_er) ~ variant + strata(week), data = data)
summary(res.cox4)

ggforest(res.cox4, data = data)
```

```{r message=FALSE, warning=FALSE}
#---------------------------------------------------------------
#Cox Regression
#own data right skewed
res. <- coxph(Surv(time_skewed,hos)~variant, data = data[data$hos==2,])
summary(res.cox_skewed)
# visualize hazard ratio
ggforest(res.cox_skewed, data = data)
```

### Table 2 - adjusted p values

* here I only simulated sex and take this into account

```{r message=FALSE, warning=FALSE}
#res.cox <- coxph(Surv(time, status) ~ age + sex + ph.ecog, data =  lung)
#own data right skewed
res.cox_skewed <- coxph(Surv(time_skewed,hos,sex)~variant, data = data[data$hos==1,])
summary(res.cox_skewed)
# visualize hazard ratio
ggforest(res.cox_skewed, data = data)
```


## Cox Regression Table 3

### Used hos=1 and vac<2

* hos=1:
* vac<2 means: Unvaccinated or <21 days after first vaccination dose
* don't know which one is correct: data$vac contains 0 and 1 and I put all 0 and 1 in a new column vac_update and coded it with 1 -> this leads to different results

```{r}
#skewed data 
#skewed data 
res.cox_vac <- coxph(Surv(time_skewed,vac)~variant, data = data[data$hos==1 & data$vac <2,])
summary(res.cox_vac)
ggsurvplot(survfit(res.cox_vac), data = data, palette = "#2E9FDF",
           ggtheme = theme_minimal())
```

### used hos=1 and vac_update == 1

```{r}
#skewed data 
#skewed data 
res.cox_vac <- coxph(Surv(time_skewed,vac_update)~variant, data = data[data$hos==1 & data$vac_update == 1,])
summary(res.cox_vac)
ggsurvplot(survfit(res.cox_vac), data = data, palette = "#2E9FDF",
           ggtheme = theme_minimal())
```

### used hos=1 and vac_update == 2

```{r}
#skewed data 
#skewed data 
res.cox_vac <- coxph(Surv(time_skewed,vac_update)~variant, data = data[data$hos==1 & data$vac_update == 2,])
summary(res.cox_vac)
ggsurvplot(survfit(res.cox_vac), data = data, palette = "#2E9FDF",
           ggtheme = theme_minimal())
```

### used hos=2 and vac<2

* hos=2:
* vac<2 means: Unvaccinated or <21 days after first vaccination dose

```{r}
#skewed data 
res.cox_vac <- coxph(Surv(time_skewed,vac)~variant, data = data[data$hos==2 & data$vac <2,])
summary(res.cox_vac)
ggsurvplot(survfit(res.cox_vac), data = data, palette = "#2E9FDF",
           ggtheme = theme_minimal())
```

### hos =1 vac == 2
* hos=1:
* vac>1 means: ≥21 days after first vaccination dose with or without second vaccination dose
* `data$vac > 2` this doesn't work yet but don't know why 
* `data$vac == 2` works but I think we also want `data$vac==3`

```{r}
#skewed data 
res.cox_vac <- coxph(Surv(time_skewed,vac)~variant, data = data[data$hos==1 & data$vac == 2,])
summary(res.cox_vac)
ggsurvplot(survfit(res.cox_vac), data = data, palette = "#2E9FDF",
           ggtheme = theme_minimal())
```

### hos=2 vac ==2
* hos=2:
* vac>1 means: ≥21 days after first vaccination dose with or without second vaccination dose
* same as above >2 doesn't work

```{r}
#skewed data 
res.cox_vac <- coxph(Surv(time_skewed,vac)~variant, data = data[data$hos==2 & data$vac==2,])
summary(res.cox_vac)
ggsurvplot(survfit(res.cox_vac), data = data, palette = "#2E9FDF",
           ggtheme = theme_minimal())
```

### used hos=2 and vac_update == 1

```{r}
#skewed data 
#skewed data 
res.cox_vac <- coxph(Surv(time_skewed,vac_update)~variant, data = data[data$hos==2 & data$vac_update == 1,])
summary(res.cox_vac)
ggsurvplot(survfit(res.cox_vac), data = data, palette = "#2E9FDF",
           ggtheme = theme_minimal())
```

### used hos=2 and vac_update == 2

```{r}
#skewed data 
#skewed data 
res.cox_vac <- coxph(Surv(time_skewed,vac_update)~variant, data = data[data$hos==2 & data$vac_update == 2,])
summary(res.cox_vac)
ggsurvplot(survfit(res.cox_vac), data = data, palette = "#2E9FDF",
           ggtheme = theme_minimal())
```

# DRAFT Code for Age

```{r eval=FALSE, include=FALSE}
#-----------------------------------------------
#draft
#age
age_n <- c(3564,9462,7636,9157,6885,3916,1681,584,453)
age_d <- c("<10","10-19","20-29","30-39","40-49","50-59","60-69","70-79",">80")
for (i in seq(from=1, to=length(age_d))){
  replicate(age_n[i],age_d[i])
}
```

